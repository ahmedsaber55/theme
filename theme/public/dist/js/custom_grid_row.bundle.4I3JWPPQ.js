(()=>{var E=class{constructor(e){this.on_grid_fields_dict={},this.on_grid_fields=[],$.extend(this,e),this.set_docfields(),this.columns={},this.columns_list=[],this.row_check_html='<input type="checkbox" class="grid-row-check">',this.make(),console.log("AAAA")}make(){let e=this,i=!0;this.wrapper=$('<div class="grid-row"></div>'),this.row=$('<div class="data-row row"></div>').appendTo(this.wrapper).on("click",function(s){if(!($(s.target).hasClass("grid-row-check")||$(s.target).hasClass("row-index")||$(s.target).parent().hasClass("row-index"))&&!(e.grid.allow_on_grid_editing()&&e.grid.is_editable()))return e.toggle_view(),!1}),this.grid.template&&!this.grid.meta.editable_grid?this.render_template():i=this.render_row(),this.render_row&&(this.set_data(),this.wrapper.appendTo(this.parent))}set_docfields(e=!1){if(this.doc&&this.parent_df.options){frappe.meta.make_docfield_copy_for(this.parent_df.options,this.doc.name,this.docfields);let i=frappe.meta.get_docfields(this.parent_df.options,this.doc.name);e?this.docfields.forEach(s=>{Object.assign(s,i.find(t=>t.fieldname===s.fieldname))}):this.docfields=i}}set_data(){this.wrapper.data({grid_row:this,doc:this.doc||""})}set_row_index(){this.doc&&this.wrapper.attr("data-name",this.doc.name).attr("data-idx",this.doc.idx).find(".row-index span, .grid-form-row-index").html(this.doc.idx)}select(e){this.doc.__checked=e?1:0}refresh_check(){this.wrapper.find(".grid-row-check").prop("checked",this.doc?!!this.doc.__checked:!1),this.grid.refresh_remove_rows_button()}remove(){var e=this;if(this.grid.is_editable())if(this.frm)this.get_open_form()&&this.hide_form(),frappe.run_serially([()=>this.frm.script_manager.trigger("before_"+this.grid.df.fieldname+"_remove",this.doc.doctype,this.doc.name),()=>{frappe.model.clear_doc(this.doc.doctype,this.doc.name),this.frm.script_manager.trigger(this.grid.df.fieldname+"_remove",this.doc.doctype,this.doc.name),this.frm.dirty(),this.grid.refresh()}]).catch(i=>{console.trace(i)});else{let i=null;this.grid.df.get_data?i=this.grid.df.get_data():i=this.grid.df.data;let s=i.findIndex(t=>t.name===e.doc.name);s>-1&&i.splice(s,1),i.forEach(function(t,r){t.idx=r+1}),this.grid.refresh()}}insert(e,i,s){var t=this.doc.idx,r=s?this.doc:null;i&&t++,this.toggle_view(!1),this.grid.add_new_row(t,null,e,r)}move(){var e=this;frappe.prompt({fieldname:"move_to",label:__("Move to Row Number"),fieldtype:"Int",reqd:1,default:this.doc.idx},function(i){if(e.doc._sortable===!1){frappe.msgprint(__("Cannot move row"));return}let s=e.grid.get_data();s.move(e.doc.idx-1,i.move_to-1);for(let t=0;t<s.length;t++)s[t].idx=t+1;e.toggle_view(!1),e.grid.refresh(),$(e.frm.wrapper).trigger("grid-move-row",[e.frm,e])},__("Move To"),"Update")}refresh(){this.frm&&this.doc&&this.doc.__islocal&&this.set_docfields(!0),this.frm&&this.doc&&(this.doc=locals[this.doc.doctype][this.doc.name]),this.grid.template&&!this.grid.meta.editable_grid?this.render_template():this.render_row(!0),this.grid_form&&this.grid_form.layout&&this.grid_form.layout.refresh(this.doc)}render_template(){this.set_row_index(),this.row_display&&this.row_display.remove(),this.row_index||(this.row_index=$(`<div class="template-row-index">${this.row_check_html}<span></span></div>`).appendTo(this.row)),this.doc&&this.row_index.find("span").html(this.doc.idx),this.row_display=$('<div class="row-data sortable-handle template-row"></div>').appendTo(this.row).html(frappe.render(this.grid.template,{doc:this.doc?frappe.get_format_helper(this.doc):null,frm:this.frm,row:this}))}render_row(e){if(this.show_search&&!this.show_search_row())return;let i=this;if(this.set_row_index(),!this.row_index&&!this.show_search){var s=this.doc?this.doc.idx:__("No.");this.row_check=$(`<div class="row-check sortable-handle col">
					${this.row_check_html}
				</div>`).appendTo(this.row),this.row_index=$(`<div class="row-index sortable-handle col">
					<span>${s}</span>
				</div>`).appendTo(this.row).on("click",function(t){$(t.target).hasClass("grid-row-check")||i.toggle_view()})}else this.show_search?(this.row_check=$('<div class="row-check col search"></div>').appendTo(this.row),this.row_index=$(`<div class="row-index col search">
					<input type="text" class="form-control input-xs text-center" >
				</div>`).appendTo(this.row),this.row_index.find("input").on("keyup",frappe.utils.debounce(t=>{let r={fieldtype:"Sr No"};this.grid.filter["row-index"]={df:r,value:t.target.value},t.target.value==""&&delete this.grid.filter["row-index"],this.grid.grid_sortable.option("disabled",Object.keys(this.grid.filter).length!==0),this.grid.prevent_build=!0,i.grid.refresh(),this.grid.prevent_build=!1},500)),frappe.utils.only_allow_num_decimal(this.row_index.find("input"))):this.row_index.find("span").html(s);return this.setup_columns(),this.add_open_form_button(),this.add_column_configure_button(),this.refresh_check(),this.frm&&this.doc&&$(this.frm.wrapper).trigger("grid-row-render",[this]),!0}make_editable(){this.row.toggleClass("editable-row",this.grid.is_editable())}is_too_small(){return this.row.width()?this.row.width()<300:!1}add_open_form_button(){var e=this;this.doc&&!this.grid.df.in_place_edit&&(this.open_form_button||(this.open_form_button=$('<div class="col"></div>').appendTo(this.row),this.configure_columns||(this.open_form_button=$(`
						<div class="btn-open-row">
							<a>${frappe.utils.icon("edit","xs")}</a>
							<div class="hidden-md edit-grid-row">${__("Edit","","Edit grid row")}</div>
						</div>
					`).appendTo(this.open_form_button).on("click",function(){return e.toggle_view(),!1})),this.is_too_small()&&this.open_form_button.css({"margin-right":"-2px"})))}add_column_configure_button(){this.grid.df.in_place_edit&&!this.frm||(this.configure_columns&&this.frm?this.configure_columns_button=$(`
				<div class="col grid-static-col d-flex justify-content-center" style="cursor: pointer;">
					<a>${frappe.utils.icon("setting-gear","sm","","filter: opacity(0.5)")}</a>
				</div>
			`).appendTo(this.row).on("click",()=>{this.configure_dialog_for_columns_selector()}):this.configure_columns&&!this.frm&&(this.configure_columns_button=$(`
				<div class="col grid-static-col"></div>
			`).appendTo(this.row)))}configure_dialog_for_columns_selector(){this.grid_settings_dialog=new frappe.ui.Dialog({title:__("Configure Columns"),fields:[{fieldtype:"HTML",fieldname:"fields_html"}]}),this.grid.setup_visible_columns(),this.setup_columns_for_dialog(),this.prepare_wrapper_for_columns(),this.render_selected_columns(),this.grid_settings_dialog.show(),$(this.fields_html_wrapper).find(".add-new-fields").click(()=>{this.column_selector_for_dialog()}),this.grid_settings_dialog.set_primary_action(__("Update"),()=>{this.validate_columns_width(),this.columns={},this.update_user_settings_for_grid(),this.grid_settings_dialog.hide()}),this.grid_settings_dialog.set_secondary_action_label(__("Reset to default")),this.grid_settings_dialog.set_secondary_action(()=>{this.reset_user_settings_for_grid(),this.grid_settings_dialog.hide()})}setup_columns_for_dialog(){this.selected_columns_for_grid=[],this.grid.visible_columns.forEach(e=>{this.selected_columns_for_grid.push({fieldname:e[0].fieldname,columns:e[0].columns||e[0].colsize})})}prepare_wrapper_for_columns(){this.fields_html_wrapper=this.grid_settings_dialog.get_field("fields_html").$wrapper[0],$(`
			<div class='form-group'>
				<div class='row' style='margin:0px; margin-bottom:10px'>
					<div class='col-md-8'>
						${__("Fieldname").bold()}
					</div>
					<div class='col-md-4' style='padding-left:5px;'>
						${__("Column Width").bold()}
					</div>
				</div>
				<div class='control-input-wrapper selected-fields'>
				</div>
				<p class='help-box small text-muted'>
					<a class='add-new-fields text-muted'>
						+ ${__("Add / Remove Columns")}
					</a>
				</p>
			</div>
		`).appendTo(this.fields_html_wrapper)}column_selector_for_dialog(){let e=this.prepare_columns_for_dialog(this.selected_columns_for_grid.map(s=>s.fieldname)),i=new frappe.ui.Dialog({title:__("{0} Fields",[__(this.grid.doctype)]),fields:[{label:__("Select Fields"),fieldtype:"MultiCheck",fieldname:"fields",options:e,columns:2}]});i.set_primary_action(__("Add"),()=>{let s=i.get_values().fields;this.selected_columns_for_grid=[],s&&(s.forEach(t=>{let r=frappe.meta.get_docfield(this.grid.doctype,t);this.grid.update_default_colsize(r),this.selected_columns_for_grid.push({fieldname:t,columns:r.columns||r.colsize})}),this.render_selected_columns(),i.hide())}),i.show()}prepare_columns_for_dialog(e){let i=[],s=frappe.model.no_value_type,t=["Button"],r=d=>t.includes(d)||!s.includes(d);return this.docfields.forEach(d=>{!d.hidden&&r(d.fieldtype)&&i.push({label:d.label,value:d.fieldname,checked:e?in_list(e,d.fieldname):!1})}),i}render_selected_columns(){let e="";this.selected_columns_for_grid&&this.selected_columns_for_grid.forEach(i=>{let s=frappe.meta.get_docfield(this.grid.doctype,i.fieldname);e+=`
					<div class='control-input flex align-center form-control fields_order sortable-handle sortable'
						style='display: block; margin-bottom: 5px; cursor: pointer;' data-fieldname='${s.fieldname}'
						data-label='${s.label}' data-type='${s.fieldtype}'>

						<div class='row'>
							<div class='col-md-1' style='padding-top: 2px'>
								<a style='cursor: grabbing;'>${frappe.utils.icon("drag","xs")}</a>
							</div>
							<div class='col-md-7' style='padding-left:0px; padding-top:3px'>
								${__(s.label)}
							</div>
							<div class='col-md-3' style='padding-left:0px;margin-top:-2px;' title='${__("Columns")}'>
								<input class='form-control column-width input-xs text-right'
									value='${s.columns||cint(i.columns)}'
									data-fieldname='${s.fieldname}' style='background-color: var(--modal-bg); display: inline'>
							</div>
							<div class='col-md-1' style='padding-top: 3px'>
								<a class='text-muted remove-field' data-fieldname='${s.fieldname}'>
									<i class='fa fa-trash-o' aria-hidden='true'></i>
								</a>
							</div>
						</div>
					</div>`}),$(this.fields_html_wrapper).find(".selected-fields").html(e),this.prepare_handler_for_sort(),this.select_on_focus(),this.update_column_width(),this.remove_selected_column()}prepare_handler_for_sort(){new Sortable($(this.fields_html_wrapper).find(".selected-fields")[0],{handle:".sortable-handle",draggable:".sortable",onUpdate:()=>{this.sort_columns()}})}sort_columns(){this.selected_columns_for_grid=[];let e=$(this.fields_html_wrapper).find(".fields_order")||[];e.each(i=>{this.selected_columns_for_grid.push({fieldname:$(e[i]).attr("data-fieldname"),columns:cint($(e[i]).find(".column-width").attr("value"))})})}select_on_focus(){$(this.fields_html_wrapper).find(".column-width").click(e=>{$(e.target).select()})}update_column_width(){$(this.fields_html_wrapper).find(".column-width").change(e=>{cint(e.target.value)===0&&(e.target.value=cint(e.target.defaultValue),frappe.throw(__("Column width cannot be zero."))),this.selected_columns_for_grid.forEach(i=>{i.fieldname===e.target.dataset.fieldname&&(i.columns=cint(e.target.value),e.target.defaultValue=cint(e.target.value))})})}validate_columns_width(){let e=0;this.selected_columns_for_grid.forEach(i=>{i.columns&&i.columns>0&&(e+=cint(i.columns))}),e&&e>10&&frappe.throw(__("The total column width cannot be more than 10."))}remove_selected_column(){$(this.fields_html_wrapper).find(".remove-field").click(e=>{let i=e.currentTarget.dataset.fieldname,s=this.selected_columns_for_grid.filter(t=>t.fieldname!==i);s&&s.length===0&&frappe.throw(__("At least one column is required to show in the grid.")),this.selected_columns_for_grid=s,$(this.fields_html_wrapper).find(`[data-fieldname="${i}"]`).remove()})}update_user_settings_for_grid(){if(!this.selected_columns_for_grid||!this.frm)return;let e={};e[this.grid.doctype]=this.selected_columns_for_grid,frappe.model.user_settings.save(this.frm.doctype,"GridView",e).then(i=>{frappe.model.user_settings[this.frm.doctype]=i.message||i,this.grid.reset_grid()})}reset_user_settings_for_grid(){frappe.model.user_settings.save(this.frm.doctype,"GridView",null).then(e=>{frappe.model.user_settings[this.frm.doctype]=e.message||e,this.grid.reset_grid()})}setup_columns(){this.focus_set=!1,this.search_columns={},this.grid.setup_visible_columns();let e=this.grid.user_defined_columns&&this.grid.user_defined_columns.length>0?this.grid.user_defined_columns:this.docfields;this.grid.visible_columns.forEach((i,s)=>{let t=e.find(n=>(n==null?void 0:n.fieldname)===i[0].fieldname);this.set_dependant_property(t);let r=i[1],d=this.doc?frappe.format(this.doc[t.fieldname],t,null,this.doc):__(t.label);this.doc&&t.fieldtype==="Select"&&(d=__(d));let l;!this.columns[t.fieldname]&&!this.show_search?l=this.make_column(t,r,d,s):!this.columns[t.fieldname]&&this.show_search?l=this.make_search_column(t,r):(l=this.columns[t.fieldname],this.refresh_field(t.fieldname,d)),this.doc&&(t.reqd&&!d&&l.addClass("error"),l.is_invalid?l.addClass("invalid"):(t.reqd||t.bold)&&l.addClass("bold"))}),this.show_search&&$('<div class="col grid-static-col search"></div>').appendTo(this.row)}set_dependant_property(e){!e.reqd&&e.mandatory_depends_on&&this.evaluate_depends_on_value(e.mandatory_depends_on)&&(e.reqd=1),!e.read_only&&e.read_only_depends_on&&this.evaluate_depends_on_value(e.read_only_depends_on)&&(e.read_only=1)}evaluate_depends_on_value(e){let i=null,s=this.doc;if(!s)return;let t=this.frm?this.frm.doc:this.doc||null;if(typeof e=="boolean")i=e;else if(typeof e=="function")i=e(s);else if(e.substr(0,5)=="eval:")try{i=frappe.utils.eval(e.substr(5),{doc:s,parent:t}),t&&t.istable&&e.includes("is_submittable")&&(i=!0)}catch(d){frappe.throw(__('Invalid "depends_on" expression'))}else if(e.substr(0,3)=="fn:"&&this.frm)i=this.frm.script_manager.trigger(e.substr(3),this.doctype,this.docname);else{var r=s[e];$.isArray(r)?i=!!r.length:i=!!r}return i}show_search_row(){var e,i;return this.show_search=this.show_search&&(((i=(e=this.grid)==null?void 0:e.data)==null?void 0:i.length)>=20||this.grid.filter_applied),!this.show_search&&this.wrapper.remove(),this.show_search}make_search_column(e,i){let s="",t="",r="";["Text","Small Text"].includes(e.fieldtype)?t="grid-overflow-no-ellipsis":["Int","Currency","Float","Percent"].includes(e.fieldtype)?t="text-right":e.fieldtype==="Check"?(s=__("1 = True & 0 = False"),t="text-center"):e.fieldtype==="Password"&&(r="disabled",s=__("Password cannot be filtered"));let d=$('<div class="col grid-static-col col-xs-'+i+' search"></div>').appendTo(this.row),l=$(`
			<input
				type="text"
				class="form-control input-xs ${t}"
				title="${s}"
				data-fieldtype="${e.fieldtype}"
				${r}
			>
		`).appendTo(d);return this.search_columns[e.fieldname]=d,l.on("keyup",frappe.utils.debounce(n=>{this.grid.filter[e.fieldname]={df:e,value:n.target.value},n.target.value==""&&delete this.grid.filter[e.fieldname],this.grid.grid_sortable.option("disabled",Object.keys(this.grid.filter).length!==0),this.grid.prevent_build=!0,this.grid.grid_pagination.go_to_page(1),this.grid.refresh(),this.grid.prevent_build=!1},500)),["Currency","Float","Int","Percent","Rating"].includes(e.fieldtype)&&frappe.utils.only_allow_num_decimal(l),d}make_column(e,i,s,t){let r=this;var d=["Text","Small Text"].indexOf(e.fieldtype)!==-1?" grid-overflow-no-ellipsis":"";d+=["Int","Currency","Float","Percent"].indexOf(e.fieldtype)!==-1?" text-right":"",d+=["Check"].indexOf(e.fieldtype)!==-1?" text-center":"";let l,n,w=0,g=0,v=0,m=!1,u=!1,c=!1;function b(o){m=!0;let p=n.getBoundingClientRect().width,h=n.getBoundingClientRect().left,a=parseFloat(l.style.left),f=o.offset().left,k=o.data("fieldtype"),T=p-(f+o.width()),y=0,C=f-h,A=p-(f-h);["Date","Time","Datetime"].includes(k)&&(y=A-220),["Link","Dynamic Link"].includes(k)&&(y=A-250),C<0?l.style.left=`${a-C}px`:y<0?l.style.left=`${a+y}px`:T<0&&(l.style.left=`${a+T}px`)}function x(){let o=document.querySelectorAll(".datepicker.active")[0];o.classList.remove("active"),o.style.width="220px",setTimeout(()=>{o.classList.add("active")},600)}var _=$('<div class="col grid-static-col col-xs-'+i+" "+d+'"></div>').attr("data-fieldname",e.fieldname).attr("data-fieldtype",e.fieldtype).data("df",e).appendTo(this.row).on("touchstart",function(o){n=$(o.currentTarget).closest(".form-grid-container")[0],l=$(o.currentTarget).closest(".form-grid")[0],l.style.position!="relative"&&$(l).css("position","relative"),!l.style.left&&$(l).css("left",0),g=o.touches[0].clientX,v=o.touches[0].clientY,w=-parseFloat(l.style.left||0)+g}).on("touchmove",function(o){if(m)return;let p,h;if(!c&&!u&&(p=Math.abs(g-o.touches[0].clientX),h=Math.abs(v-o.touches[0].clientY)),!u&&p>16?c=!0:!c&&h>16&&(u=!0),c){o.preventDefault();let a=w-o.touches[0].clientX,f=l.clientWidth-n.clientWidth+2;frappe.utils.is_rtl()&&(a=-a),a<0?a=0:a>f&&(a=f),l.style.left=`${frappe.utils.is_rtl()?"":"-"}${a}px`}}).on("touchend",function(){u=!1,c=!1}).on("click",function(o){if(frappe.ui.form.editable_row!==r)var p=r.toggle_editable_row();var h=this;let a=$(h).find('input[type="Text"]:first'),f=!1;return $(h).find("input[type='text']").each(function(){$(this).is(":focus")&&(f=!0)}),!f&&a.trigger("focus"),o.pointerType=="touch"&&(a.length&&b(a),a.one("blur",()=>f=!1),a.data("fieldtype")=="Date"&&x()),p});return _.field_area=$('<div class="field-area"></div>').appendTo(_).toggle(!1),_.static_area=$('<div class="static-area ellipsis"></div>').appendTo(_).html(s),this.doc||_.attr("title",s),e.fieldname&&_.static_area.toggleClass("reqd",Boolean(e.reqd)),_.df=e,_.column_index=t,this.columns[e.fieldname]=_,this.columns_list.push(_),_}activate(){return this.toggle_editable_row(!0),this}toggle_editable_row(e){var i=this;if(this.grid.allow_on_grid_editing()&&this.grid.is_editable()&&this.doc&&e!==!1)return frappe.ui.form.editable_row&&frappe.ui.form.editable_row!==this&&frappe.ui.form.editable_row.toggle_editable_row(!1),this.row.toggleClass("editable-row",!0),this.columns_list.forEach(function(s){i.make_control(s),s.static_area.toggle(!1),s.field_area.toggle(!0)}),frappe.ui.form.editable_row=this,!1;this.row.toggleClass("editable-row",!1),this.columns_list.forEach((s,t)=>{if(!this.frm){let r=this.grid.visible_columns[t][0],d=this.doc?frappe.format(this.doc[r.fieldname],r,null,this.doc):__(r.label);this.refresh_field(r.fieldname,d)}s.df.hidden||s.static_area.toggle(!0),s.field_area&&s.field_area.toggle(!1)}),frappe.ui.form.editable_row=null}make_control(e){if(!e.field){var i=this,s=e.field_area,t=e.df;t.fieldtype=="Text Editor"&&(t=Object.assign({},t),t.fieldtype="Text");var r=frappe.ui.form.make_control({df:t,parent:s,only_input:!0,with_link_btn:!0,doc:this.doc,doctype:this.doc.doctype,docname:this.doc.name,frm:this.grid.frm,grid:this.grid,grid_row:this,value:this.doc[t.fieldname]});if(r.get_query=this.grid.get_field(t.fieldname).get_query,!r.df.onchange_modified){var d=r.df.onchange;r.df.onchange=l=>{d&&d(l),this.refresh_field(r.df.fieldname)},r.df.onchange_modified=!0}r.refresh(),r.$input&&(r.$input.addClass("input-sm").attr("data-col-idx",e.column_index).attr("placeholder",__(t.placeholder||t.label)),this.columns_list&&this.columns_list.slice(-1)[0]===e&&r.$input.attr("data-last-input",1)),this.set_arrow_keys(r),e.field=r,this.on_grid_fields_dict[t.fieldname]=r,this.on_grid_fields.push(r)}}set_arrow_keys(e){var i=this;let s=["Text","Small Text","Code","Text Editor","HTML Editor"];e.$input&&e.$input.on("keydown",function(t){var{TAB:r,UP:d,DOWN:l}=frappe.ui.keyCode;if(!in_list([r,d,l],t.which))return;var n=i.grid.get_data(),w=$(this).attr("data-fieldname"),g=$(this).attr("data-fieldtype");let v=t.metaKey||t.ctrlKey;if(!in_list(s,g)&&v&&t.which!==r){i.add_new_row_using_keys(t);return}if(t.shiftKey&&t.altKey&&l===t.which){i.duplicate_row_using_keys();return}var m=function(_){if(in_list(s,g)&&!t.altKey||e.autocomplete_open)return!1;_.toggle_editable_row();var o=_.columns[w].field.$input;return o&&o.focus(),!0};if(t.which===r&&!t.shiftKey){var u=i.wrapper.find(":input:enabled:last").get(0),c=$(this).attr("data-last-input")||u===this;if(c)if(i.doc.idx===n.length)setTimeout(function(){i.grid.add_new_row(null,null,!0),i.grid.grid_rows[i.grid.grid_rows.length-1].toggle_editable_row(),i.grid.set_focus_on_row()},100);else return i.grid.grid_rows[i.doc.idx].toggle_editable_row(),i.grid.set_focus_on_row(i.doc.idx),!1}else if(t.which===d){if(i.doc.idx>1){var b=i.grid.grid_rows[i.doc.idx-2];if(m(b))return!1}}else if(t.which===l&&i.doc.idx<n.length){var x=i.grid.grid_rows[i.doc.idx];if(m(x))return!1}})}duplicate_row_using_keys(){setTimeout(()=>{this.insert(!1,!0,!0),this.grid.grid_rows[this.doc.idx].toggle_editable_row(),this.grid.set_focus_on_row(this.doc.idx)},100)}add_new_row_using_keys(e){let i="",s=e.metaKey||e.ctrlKey,t=e.which===40;s&&e.shiftKey?(i=t?null:1,this.grid.add_new_row(i,null,t,!1,t,!t),i=t?cint(this.grid.grid_rows.length)-1:0):s&&(i=t?this.doc.idx:this.doc.idx-1,this.insert(!1,t)),i!==""&&setTimeout(()=>{this.grid.grid_rows[i].toggle_editable_row(),this.grid.set_focus_on_row(i)},100)}get_open_form(){return frappe.ui.form.get_open_grid_form()}toggle_view(e,i){if(!this.doc)return this;this.frm&&(this.doc=locals[this.doc.doctype][this.doc.name]);var s=this.get_open_form();if(e===void 0&&(e=!s),document.activeElement&&document.activeElement.blur(),e&&s)if(s==this){i&&i();return}else s.toggle_view(!1);return e?this.show_form():this.hide_form(),i&&i(),this}show_form(){frappe.utils.is_xs()&&($(this.grid.form_grid).css("min-width","0"),$(this.grid.form_grid).css("position","unset")),this.grid_form||(this.grid_form=new GridRowForm({row:this})),this.grid_form.render(),this.row.toggle(!1);let e=this.grid.cannot_add_rows||this.grid.df&&this.grid.df.cannot_add_rows;this.wrapper.find(".grid-insert-row-below, .grid-insert-row, .grid-duplicate-row, .grid-append-row").toggle(!e),this.wrapper.find(".grid-delete-row").toggle(!(this.grid.df&&this.grid.df.cannot_delete_rows)),frappe.dom.freeze("","dark grid-form"),cur_frm&&(cur_frm.cur_grid=this),this.wrapper.addClass("grid-row-open"),console.log("AAABBBB"),this.frm&&(this.frm.script_manager.trigger(this.doc.parentfield+"_on_form_rendered"),this.frm.script_manager.trigger("form_render",this.doc.doctype,this.doc.name))}hide_form(){frappe.utils.is_xs()&&($(this.grid.form_grid).css("min-width","738px"),$(this.grid.form_grid).css("position","relative")),frappe.dom.unfreeze(),this.row.toggle(!0),console.log("AAABBBBCCC"),this.refresh(),cur_frm&&(cur_frm.cur_grid=null),this.wrapper.removeClass("grid-row-open")}open_prev(){!this.doc||this.open_row_at_index(this.doc.idx-2)}open_next(){!this.doc||this.open_row_at_index(this.doc.idx)||this.grid.add_new_row(null,null,!0)}open_row_at_index(e){if(!!this.grid.data[e])return this.change_page_if_reqd(e),this.grid.grid_rows[e].toggle_view(!0),!0}change_page_if_reqd(e){let{page_index:i,page_length:s}=this.grid.grid_pagination;e++;let t;e<=(i-1)*s?t=i-1:e>i*s&&(t=i+1),t&&this.grid.grid_pagination.go_to_page(t)}refresh_field(e,i){let t=(this.grid.user_defined_columns&&this.grid.user_defined_columns.length>0?this.grid.user_defined_columns:this.docfields).find(l=>(l==null?void 0:l.fieldname)===e);t&&this.doc&&(i=frappe.format(this.doc[e],t,null,this.doc)),!i&&this.frm&&(i=frappe.format(this.doc[e],t,null,this.frm.doc));let r=this.columns[e];r&&(r.static_area.html(i||""),t&&t.reqd&&r.toggleClass("error",i===null||i===""));let d=this.on_grid_fields_dict[e];d&&(d.docname=this.doc.name,d.refresh()),this.grid_form&&this.grid_form.refresh_field(e)}get_field(e){let i=this.on_grid_fields_dict[e];if(i)return i;if(this.grid_form)return this.grid_form.fields_dict[e];throw`fieldname ${e} not found`}get_visible_columns(e=[]){var i=this,s=$.map(this.docfields,function(t){var r=!t.hidden&&t.in_list_view&&i.grid.frm.get_perm(t.permlevel,"read")&&!in_list(frappe.model.layout_fields,t.fieldtype)&&!in_list(e,t.fieldname);return r?t:null});return s}set_field_property(e,i,s){var t=this,r=function(d){!d||(d.df[i]=s,d.refresh())};this.grid_form&&(r(this.grid_form.fields_dict[e]),this.grid_form.layout&&this.grid_form.layout.refresh_sections()),r(this.on_grid_fields_dict[e])}toggle_reqd(e,i){this.set_field_property(e,"reqd",i?1:0)}toggle_display(e,i){this.set_field_property(e,"hidden",i?0:1)}toggle_editable(e,i){this.set_field_property(e,"read_only",i?0:1)}};})();
//# sourceMappingURL=custom_grid_row.bundle.4I3JWPPQ.js.map
